<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم HELDEN - إدارة الطلبات</title>
<!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1731092407482872');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1731092407482872&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Estilos CSS aquí -->
    <style>
        :root {
            --primary-color: #4a6de5;
            --secondary-color: #8f94fb;
            --accent-color: #FF6B6B;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f5f7ff;
            color: #333;
        
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--box-shadow);
        
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: transform 0.3s ease;
        
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        
        }
        
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark-color);
        
        }
        
        .filters-container {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        
        }
        
        .orders-table {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        
        }
        
        .status-pending {
            background-color: var(--warning-color);
            color: white;
        
        }
        
        .status-processing {
            background-color: var(--primary-color);
            color: white;
        
        }
        
        .status-shipped {
            background-color: var(--secondary-color);
            color: white;
        
        }
        
        .status-delivered {
            background-color: var(--success-color);
            color: white;
        
        }
        
        .status-cancelled {
            background-color: var(--danger-color);
            color: white;
        
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: var(--border-radius);
            margin-right: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        
        }
        
        .view-btn {
            background-color: var(--primary-color);
            color: white;
        
        }
        
        .view-btn:hover {
            background-color: #3a5bd4;
        
        }
        
        .export-btn {
            background-color: #28a745;
            color: white;
        
        }
        
        .export-btn:hover {
            background-color: #218838;
        
        }
        
        .export-single-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
        
        }
        
        .export-single-btn:hover {
            transform: scale(1.2);
        
        }
        
        .export-single-btn i {
            font-size: 1.1rem;
        
        }
        
        /* Order Modal Styling */
        .order-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        
        }
        
        .order-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        
        }
        
        .order-modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        
        }
        
        .order-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        
        }
        
        .order-modal-body {
            padding: 20px;
        
        }
        
        .order-info-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        
        }
        
        .product-item {
            display: flex;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
        
        }
        
        .product-details {
            flex-grow: 1;
        
        }
        
        .status-update-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr 1fr;
            
        }
            
            .table-responsive {
                font-size: 0.85rem;
            
        }
        
        }
        
        /* Estilos para la edición de pedidos */
        .edit-mode .form-control {
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        
        }
        
        .edit-mode .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 109, 229, 0.25);
        
        }
        
        .product-item.editable {
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        
        }
        
        .product-item.editable:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        
        }
        
        .product-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        
        }
        
        .product-edit-controls {
            background: #f0f0f0;
            padding: 10px;
            margin-top: 10px;
            border-radius: var(--border-radius);
            display: none;
        
        }
        
        .product-item.editing .product-edit-controls {
            display: block;
        
        }
        
        .new-product-form {
            background: #f5f9ff;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 1px dashed var(--primary-color);
        
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; 
        }
            to { opacity: 1; 
        }
        
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        
        }
        
        /* أنماط روابط الهاتف والواتساب */
        .phone-link {
            color: #333;
            text-decoration: none;
            transition: color 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
        
        }
        
        .phone-link:hover {
            color: var(--primary-color);
        
        }
        
        .phone-link:before {
            content: "\f095";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 5px;
            font-size: 0.9em;
            color: #666;
        
        }
        
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #f0f0f0;
            transition: all 0.3s ease;
        
        }
        
        .whatsapp-link:hover {
            background-color: #e6ffe6;
            transform: scale(1.1);
        
        }
        
        .whatsapp-link i {
            font-size: 16px;
        
        }
        
        .whatsapp-link-small {
            width: 20px;
            height: 20px;
        
        }
        
        .whatsapp-link-small i {
            font-size: 12px;
        
        }
        
        /* Indicador de guardado automático */
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 9999;
        
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <h2 class="text-center mb-4">تسجيل دخول المشرف</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="adminUsername" class="form-label">اسم المستخدم</label>
                <input type="text" class="form-control" id="adminUsername" required>
            </div>
            <div class="mb-3">
                <label for="adminPassword" class="form-label">كلمة المرور</label>
                <input type="password" class="form-control" id="adminPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">تسجيل الدخول</button>
        </form>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer" class="admin-container" style="display: none;">
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-tshirt me-2"></i> لوحة تحكم HELDEN</h1>
                    <p class="mb-0">مرحبًا بك في لوحة التحكم لإدارة طلبات HELDEN</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button onclick="logoutAdmin()" class="btn btn-light">
                        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <i class="fas fa-shopping-cart"></i>
                <div class="stat-title">إجمالي الطلبات</div>
                <div class="stat-value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock"></i>
                <div class="stat-title">قيد الانتظار</div>
                <div class="stat-value" id="pendingOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-box"></i>
                <div class="stat-title">جاري التجهيز</div>
                <div class="stat-value" id="processingOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="stat-title">تم التوصيل</div>
                <div class="stat-value" id="deliveredOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-money-bill-wave"></i>
                <div class="stat-title">إجمالي الإيرادات</div>
                <div class="stat-value" id="totalRevenue">0 ج.م</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="row g-2 align-items-center">
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary filter-btn active" data-filter="all">الكل</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="pending">قيد الانتظار</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="processing">جاري التجهيز</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="shipped">تم الشحن</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="delivered">تم التوصيل</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="البحث عن طلب (رقم الطلب، اسم العميل، رقم الهاتف)">
                    </div>
                </div>
            </div>
            
            <!-- Date Filter Row -->
            <div class="row g-2 align-items-center mt-2">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label class="me-2 mb-0">من:</label>
                        <input type="date" class="form-control" id="dateFromFilter">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label class="me-2 mb-0">إلى:</label>
                        <input type="date" class="form-control" id="dateToFilter">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="btn-group w-100">
                        <button type="button" class="btn btn-outline-primary w-50" id="todayFilterBtn">طلبات اليوم</button>
                        <button type="button" class="btn btn-outline-secondary w-50" id="clearDateFilterBtn">مسح الفلتر</button>
                    </div>
                </div>
            </div>
            
            <!-- Order By Date Row -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <label class="me-2 mb-0">ترتيب حسب:</label>
                        <select class="form-select" id="orderSortSelect">
                            <option value="newest">الأحدث أولاً</option>
                            <option value="oldest">الأقدم أولاً</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end">
                        <button id="exportBtn" class="btn btn-success">
                            <i class="fas fa-file-excel me-1"></i> تصدير الطلبات المفلترة
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Filter Summary -->
            <div class="mt-3 text-muted" id="filterSummary" style="display: none;">
                <i class="fas fa-filter me-1"></i> 
                <span id="filterSummaryText">الطلبات المفلترة: </span>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
            <table class="table table-hover" id="ordersTable">
                <thead class="table-light">
                    <tr>
                        <th>رقم الطلب</th>
                        <th>اسم العميل</th>
                        <th>رقم الهاتف</th>
                        <th>المحافظة</th>
                        <th>تاريخ الطلب</th>
                        <th>عدد المنتجات</th>
                        <th>المبلغ الإجمالي</th>
                        <th>تفاصيل المنتجات</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Table rows will be added dynamically -->
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-shopping-bag"></i>
                <h4>لا توجد طلبات</h4>
                <p>لم يتم العثور على أي طلبات في النظام حاليًا.</p>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModalBackdrop" class="order-modal-backdrop"></div>
    <div id="orderModal" class="order-modal">
        <div class="order-modal-header">
            <h3>تفاصيل الطلب <span id="orderDetailId"></span></h3>
            <button id="orderModalClose" class="order-modal-close">&times;</button>
        </div>
        <div class="order-modal-body">
            <div class="row order-info-section">
                <div class="col-md-6">
                    <h5>معلومات الطلب</h5>
                    <p><strong>رقم الطلب:</strong> <span id="orderDetailId"></span></p>
                    <p><strong>تاريخ الطلب:</strong> <span id="orderDetailDate"></span></p>
                    <p>
                        <strong>الحالة الحالية:</strong> <span id="currentStatus" class="status-badge"></span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="editOrderBtn" title="تعديل الطلب">
                            <i class="fas fa-edit"></i>
                        </button>
                    </p>
                </div>
                <div class="col-md-6">
                    <h5>معلومات العميل</h5>
                    <div class="view-mode">
                        <p><strong>الاسم:</strong> <span id="customerName"></span></p>
                        <p><strong>رقم الهاتف:</strong> <span id="customerPhone"></span></p>
                        <p><strong>المحافظة:</strong> <span id="customerGovernorate"></span></p>
                        <p><strong>العنوان:</strong> <span id="customerAddress"></span></p>
                        <p><strong>ملاحظات:</strong> <span id="orderNotes"></span></p>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <div class="mb-2">
                            <label class="form-label">الاسم:</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">رقم الهاتف:</label>
                            <input type="text" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">رقم هاتف بديل:</label>
                            <input type="text" class="form-control" id="editCustomerAltPhone">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">المحافظة:</label>
                            <input type="text" class="form-control" id="editCustomerGovernorate">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">العنوان:</label>
                            <textarea class="form-control" id="editCustomerAddress" rows="2"></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">ملاحظات:</label>
                            <textarea class="form-control" id="editOrderNotes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="order-info-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>المنتجات</h5>
                    <div class="edit-mode" style="display: none;">
                        <button type="button" class="btn btn-sm btn-success" id="addNewProductBtn">
                            <i class="fas fa-plus"></i> إضافة طقم جديد
                        </button>
                    </div>
                </div>
                <div id="productsContainer">
                    <!-- Product details will be added dynamically -->
                </div>
                
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="view-mode">
                                <p><strong>المبلغ الإجمالي:</strong> <span id="orderTotal"></span></p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <div class="mb-2">
                                    <label class="form-label">المبلغ الإجمالي:</label>
                                    <input type="text" class="form-control" id="editOrderTotal">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">خصم (%):</label>
                                    <input type="number" class="form-control" id="editOrderDiscount" min="0" max="100" step="1" value="0">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">المبلغ النهائي بعد الخصم:</label>
                                    <input type="text" class="form-control" id="editOrderFinalTotal" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Complete Order Details Section -->
            <div class="order-info-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>جميع بيانات الطلب</h5>
                </div>
                <div class="complete-order-details">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <tbody id="completeOrderDetails">
                                <!-- Complete order data will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="status-update-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>تحديث حالة الطلب</h5>
                    <div class="edit-mode" style="display: none;">
                        <button type="button" class="btn btn-success" id="saveOrderChangesBtn">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" id="cancelEditBtn">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-md-8">
                        <select id="statusUpdateSelect" class="form-select">
                            <option value="pending">قيد الانتظار</option>
                            <option value="processing">جاري التجهيز</option>
                            <option value="shipped">تم الشحن</option>
                            <option value="delivered">تم التوصيل</option>
                            <option value="cancelled">ملغي</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="updateStatusBtn" class="btn btn-primary w-100" data-order-id="">تحديث الحالة</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Load Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- Load SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6BFfrTIeNVWQLV8dg_824Mm1y1X5jd4c",
            authDomain: "lotus-mens.firebaseapp.com",
            databaseURL: "https://lotus-mens-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lotus-mens",
            storageBucket: "lotus-mens.firebasestorage.app",
            messagingSenderId: "454852482854",
            appId: "1:454852482854:web:64bae49af3cb69790d93e7",
            measurementId: "G-ZZ3K5EQC9R"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        const db = firebase.firestore();
        let currentUser = null;

        // Variables globales
        let allOrders = [];
        let currentFilter = 'all';
        let adminLoggedIn = false;
        const ADMIN_EMAIL = 'senatorever@gmail.com'; // Updated Admin Email
        let dateFromFilter = null;
        let dateToFilter = null;

        // Elementos DOM
        const loginForm = document.getElementById('loginForm');
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('searchInput');
        const orderModal = document.getElementById('orderModal');
        const orderModalBackdrop = document.getElementById('orderModalBackdrop');
        const statusUpdateSelect = document.getElementById('statusUpdateSelect');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const orderModalClose = document.getElementById('orderModalClose');
        const emptyStateElement = document.getElementById('emptyState');

        // Elementos para edición de pedidos
        let editOrderBtn;
        let saveOrderChangesBtn;
        let cancelEditBtn;
        let addNewProductBtn;
        let currentOrderData;
        let editMode = false;

        // Create row for orders
        function createOrderRowHTML(order) {
            const statusClass = `status-${order.status || 'pending'
        }`;
            const statusText = getStatusText(order.status || 'pending');
            const whatsappLink = createWhatsAppLink(order.customer_mobile, order.order_number);

            // تحديد عدد المنتجات
            let totalItems = order.total_items || '';
            
            // تنسيق تفاصيل المنتجات كنص مختصر
            let productsText = '';
            try {
                let products = [];
                if (typeof order.product_details === 'string') {
                    products = JSON.parse(order.product_details);
                
        } else if (Array.isArray(order.product_details)) {
                    products = order.product_details;
                
        } else if (Array.isArray(order.products)) {
                    products = order.products;
                    if (!order.total_items) {
                        totalItems = products.length;
                    
        }
                
        }
                
                if (products && products.length > 0) {
                    productsText = products.map(p => 
                        `${getColorName(p.color)
        } - ${p.size} (${p.quantity})`
                    ).join(' | ');
                
        }
            
        } catch (e) {
                console.error("Error parsing product details:", e);
            
        }
            
            return `
                <tr>
                    <td>${order.order_number
        }</td>
                    <td>${order.customer_name
        }</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <a href="tel:${order.customer_mobile
        }" class="phone-link me-2">
                                ${order.customer_mobile
        }
                            </a>
                            <a href="${whatsappLink
        }" target="_blank" class="whatsapp-link" title="إرسال رسالة واتساب">
                                <i class="fab fa-whatsapp text-success"></i>
                            </a>
                        </div>
                    </td>
                    <td>${order.customer_governorate || '-'
        }</td>
                    <td>${formatDate(order.order_date)
        }</td>
                    <td>${totalItems
        }</td>
                    <td>${order.total_price || '-'
        }</td>
                    <td>${productsText ? `<small class="text-muted">${productsText
        }</small>` : '-'}</td>
                    <td><span class="status-badge ${statusClass
        }">${statusText}</span></td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewOrderDetails('${order.id
        }')">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                    </td>
                </tr>
            `;
        
        }

        // Mostrar pedidos en la tabla
        function displayOrders(orders) {
            if (orders.length === 0) {
                showEmptyState();
                return;
            
        }
            
            hideEmptyState();
            ordersTableBody.innerHTML = '';
            
            orders.forEach(order => {
                ordersTableBody.innerHTML += createOrderRowHTML(order);
            
        });
        
        }

        // Estadísticas
        const totalOrdersElement = document.getElementById('totalOrders');
        const pendingOrdersElement = document.getElementById('pendingOrders');
        const processingOrdersElement = document.getElementById('processingOrders');
        const deliveredOrdersElement = document.getElementById('deliveredOrders');
        const totalRevenueElement = document.getElementById('totalRevenue');

        // Inicialización cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Comprobar estado de autenticación
            checkAuthState();
            
            // Event listeners
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            
        }
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentFilter = button.dataset.filter;
                    filterOrders(currentFilter);
                    updateActiveFilterButton(button);
                
        });
            
        });
            
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            
        }
            
            if (orderModalClose) {
                orderModalClose.addEventListener('click', closeOrderModal);
            
        }
            
            if (orderModalBackdrop) {
                orderModalBackdrop.addEventListener('click', closeOrderModal);
            
        }
            
            if (updateStatusBtn) {
                updateStatusBtn.addEventListener('click', updateOrderStatus);
            
        }

            // ربط زر التصدير بوظيفة التصدير
            const exportButton = document.getElementById('exportBtn');
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    console.log('زر تصدير Excel تم النقر عليه');
                    exportOrdersToExcel();
                
        });
            
        }

            // إضافة مستمعات أحداث لفلاتر التاريخ
            document.getElementById('dateFromFilter').addEventListener('change', function() {
                dateFromFilter = this.value ? new Date(this.value) : null;
                applyFilters();
            
        });
            
            document.getElementById('dateToFilter').addEventListener('change', function() {
                dateToFilter = this.value ? new Date(this.value) : null;
                applyFilters();
            
        });
            
            document.getElementById('todayFilterBtn').addEventListener('click', function() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                document.getElementById('dateFromFilter').value = todayStr;
                document.getElementById('dateToFilter').value = todayStr;
                dateFromFilter = new Date(todayStr);
                dateToFilter = new Date(todayStr);
                dateToFilter.setHours(23, 59, 59, 999); // إنهاء اليوم
                applyFilters();
            
        });
            
            document.getElementById('clearDateFilterBtn').addEventListener('click', function() {
                document.getElementById('dateFromFilter').value = '';
                document.getElementById('dateToFilter').value = '';
                dateFromFilter = null;
                dateToFilter = null;
                applyFilters();
            
        });

            // Después de cargar el DOM, inicializar los elementos de edición
            editOrderBtn = document.getElementById('editOrderBtn');
            saveOrderChangesBtn = document.getElementById('saveOrderChangesBtn');
            cancelEditBtn = document.getElementById('cancelEditBtn');
            addNewProductBtn = document.getElementById('addNewProductBtn');
            
            if (editOrderBtn) {
                editOrderBtn.addEventListener('click', enterEditMode);
            
        }
            
            if (saveOrderChangesBtn) {
                saveOrderChangesBtn.addEventListener('click', saveOrderChanges);
            
        }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', exitEditMode);
            
        }
            
            if (addNewProductBtn) {
                addNewProductBtn.addEventListener('click', addNewProduct);
            
        }
            
            // Inicializar evento para el descuento
            const discountInput = document.getElementById('editOrderDiscount');
            if (discountInput) {
                discountInput.addEventListener('input', updateFinalPrice);
            
        }
            
            // Inicializar evento para el precio total
            const totalInput = document.getElementById('editOrderTotal');
            if (totalInput) {
                totalInput.addEventListener('input', updateFinalPrice);
            
        }
            
            // ربط حدث تغيير الترتيب
            const orderSortSelect = document.getElementById('orderSortSelect');
            if (orderSortSelect) {
                orderSortSelect.addEventListener('change', applyFilters);
            
        }
        
        });

        // Verificar el estado de autenticación
        function checkAuthState() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    // Verificamos que el usuario es el administrador
                    if (user.email === ADMIN_EMAIL) {
                        console.log("Usuario autenticado:", user.email);
                        adminLoggedIn = true;
                        showDashboard();
                        fetchOrders();
                    
        } else {
                        // Si no es el administrador, cerramos sesión
                        console.warn("Usuario autenticado pero no es administrador:", user.email);
                        logoutAdmin();
                        alert('No tienes permisos de administrador');
                    
        }
                
        } else {
                    // No hay usuario autenticado
                    console.log("No hay usuario autenticado");
                    adminLoggedIn = false;
                    showLoginForm();
                
        }
            
        });
        
        }

        // Manejar el inicio de sesión
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Mostrar indicador de carga
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تسجيل الدخول...';
            
            // Solución temporal: validación directa para el administrador
            if ((username === 'admin' || username === 'admin@solyhux.com') && password === 'Soly2025!') {
                console.log("Inicio de sesión directo para el administrador");
                adminLoggedIn = true;
                localStorage.setItem('adminSession', 'active');
                localStorage.setItem('adminUID', 'oNpkebc26JeGvH5242eBG9GIzwH3');
                showDashboard();
                fetchOrders();
                return;
            
        }
            
            // Verificar si es el formato de correo electrónico correcto
            const email = username.includes('@') ? username : `${username
        }@solyhux.com`;
            
            // Autenticar con Firebase
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Usuario autenticado exitosamente
                    console.log("Inicio de sesión exitoso");
                    localStorage.setItem('adminSession', 'active');
                
        })
                .catch((error) => {
                    console.error("Error de autenticación:", error);
                    alert('اسم المستخدم أو كلمة المرور غير صحيحة');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                
        });
        
        }

        // Mostrar formulario de inicio de sesión
        function showLoginForm() {
            loginContainer.style.display = 'block';
            dashboardContainer.style.display = 'none';
        
        }

        // Mostrar panel principal
        function showDashboard() {
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
        
        }

        // Cerrar sesión
        function logoutAdmin() {
            firebase.auth().signOut()
                .then(() => {
                    adminLoggedIn = false;
                    localStorage.removeItem('adminSession');
                    showLoginForm();
                
        })
                .catch((error) => {
                    console.error("Error al cerrar sesión:", error);
                
        });
        
        }

        // Obtener pedidos desde Firebase
        function fetchOrders() {
            // Mostrar estado de carga
            ordersTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i> جاري تحميل الطلبات...</td></tr>';
            
            console.log("Intentando obtener pedidos...");
            console.log("Estado de autenticación:", firebase.auth().currentUser ? "Autenticado" : "No autenticado");
            if (firebase.auth().currentUser) {
                console.log("Usuario actual:", firebase.auth().currentUser.email);
                console.log("UID:", firebase.auth().currentUser.uid);
            
        }
            
            db.collection('orders').get()
                .then(snapshot => {
                    console.log("Pedidos obtenidos con éxito, cantidad:", snapshot.size);
                    allOrders = [];
                    snapshot.forEach(doc => {
                        allOrders.push({
                            id: doc.id,
                            ...doc.data()
                        
        });
                    
        });
                    
                    updateStatistics();
                    displayOrders(allOrders);
                
        })
                .catch(error => {
                    console.error("Error fetching orders: ", error);
                    console.error("Código:", error.code);
                    console.error("Mensaje:", error.message);
                    
                    // Si el error es de permisos, intentamos una solución alternativa
                    if (error.code === 'permission-denied') {
                        console.log("Intentando solución alternativa para permisos...");
                        alert("يرجى الذهاب إلى Firebase وتعديل قواعد الأمان لـ Firestore للسماح بالقراءة.\\n\\nrules_version = '2';\\nservice cloud.firestore {\\n  match /databases/{database}/documents {\\n    match /{document=**} {\\n      allow read, write: if true;\\n    }\\n  }\\n}");
                    
        }
                    
                    showErrorState("حدث خطأ أثناء جلب الطلبات: " + error.message);
                
        });
        
        }

        // Actualizar estadísticas
        function updateStatistics() {
            if (allOrders.length === 0) {
                totalOrdersElement.textContent = '0';
                pendingOrdersElement.textContent = '0';
                processingOrdersElement.textContent = '0';
                deliveredOrdersElement.textContent = '0';
                totalRevenueElement.textContent = '0 ج.م';
                return;
            
        }
            
            const pendingCount = allOrders.filter(order => order.status === 'pending').length;
            const processingCount = allOrders.filter(order => order.status === 'processing').length;
            const deliveredCount = allOrders.filter(order => order.status === 'delivered').length;
            
            // Calcular ingresos totales
            let totalRevenue = 0;
            allOrders.forEach(order => {
                const priceStr = order.total_price;
                if (priceStr) {
                    // Extraer solo los números del formato "XXX ج.م"
                    const price = parseInt(priceStr.replace(/[^\d]/g, ''));
                    if (!isNaN(price)) {
                        totalRevenue += price;
                    
        }
                
        }
            
        });
            
            totalOrdersElement.textContent = allOrders.length;
            pendingOrdersElement.textContent = pendingCount;
            processingOrdersElement.textContent = processingCount;
            deliveredOrdersElement.textContent = deliveredCount;
            totalRevenueElement.textContent = `${totalRevenue
        } ج.م`;
            
            // تحديث ملخص الفلترة إذا كانت هناك طلبات
            if (currentFilter === 'all' && !searchInput.value.trim()) {
                updateFilterSummary(allOrders.length);
            
        }
        
        }

        // Filtrar pedidos por estado
        function filterOrders(filter) {
            applyFilters();
        
        }
        
        // تطبيق جميع الفلاتر
        function applyFilters() {
            let filteredOrders = allOrders;
            
            // تطبيق فلتر الحالة
            if (currentFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === currentFilter);
            
        }
            
            // تطبيق فلتر التاريخ
            if (dateFromFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    let orderDate;
                    try {
                        orderDate = new Date(order.order_date);
                    
        } catch (e) {
                        return false;
                    
        }
                    return orderDate >= dateFromFilter;
                
        });
            
        }
            
            if (dateToFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    let orderDate;
                    try {
                        orderDate = new Date(order.order_date);
                    
        } catch (e) {
                        return false;
                    
        }
                    return orderDate <= dateToFilter;
                
        });
            
        }
            
            // تطبيق فلتر البحث
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(order => {
                    return (
                        order.order_number.toLowerCase().includes(searchTerm) ||
                        order.customer_name.toLowerCase().includes(searchTerm) ||
                        order.customer_mobile.includes(searchTerm)
                    );
                
        });
            
        }
            
            // تطبيق فلتر الترتيب حسب التاريخ
            const orderSortSelect = document.getElementById('orderSortSelect');
            if (orderSortSelect) {
                const orderSortValue = orderSortSelect.value;
                if (orderSortValue === 'newest') {
                    filteredOrders.sort((a, b) => {
                        const dateA = new Date(a.order_date);
                        const dateB = new Date(b.order_date);
                        return dateB - dateA;
                    
        });
                
        } else if (orderSortValue === 'oldest') {
                    filteredOrders.sort((a, b) => {
                        const dateA = new Date(a.order_date);
                        const dateB = new Date(b.order_date);
                        return dateA - dateB;
                    
        });
                
        }
            
        }
            
            displayOrders(filteredOrders);
            updateFilterSummary(filteredOrders.length);
        
        }

        // Buscar pedidos
        function handleSearch() {
            applyFilters();
        
        }
        
        // تحديث ملخص الفلتر
        function updateFilterSummary(count) {
            const filterSummary = document.getElementById('filterSummary');
            const filterSummaryText = document.getElementById('filterSummaryText');
            
            if (!filterSummary || !filterSummaryText) return;
            
            let summaryText = 'الطلبات المفلترة: ';
            
            // إضافة نوع الفلتر إذا كان مختلفاً عن "الكل"
            if (currentFilter !== 'all') {
                summaryText += `حالة الطلب: ${getStatusText(currentFilter)
        }`;
            
        } else {
                summaryText += 'جميع الحالات';
            
        }
            
            // إضافة معلومات فلتر التاريخ
            if (dateFromFilter || dateToFilter) {
                summaryText += ' | التاريخ: ';
                
                if (dateFromFilter) {
                    const fromDateStr = dateFromFilter.toLocaleDateString('ar-EG');
                    summaryText += `من ${fromDateStr
        }`;
                
        }
                
                if (dateToFilter) {
                    const toDateStr = dateToFilter.toLocaleDateString('ar-EG');
                    summaryText += `${dateFromFilter ? ' ' : ''
        }إلى ${toDateStr}`;
                
        }
            
        }
            
            // إضافة مصطلح البحث إذا كان موجوداً
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                summaryText += ` | بحث عن: "${searchTerm
        }"`;
            
        }
            
            // إضافة العدد الإجمالي للنتائج
            summaryText += ` | عدد النتائج: ${count
        } من أصل ${allOrders.length}`;
            
            filterSummaryText.textContent = summaryText;
            
            // إظهار أو إخفاء ملخص الفلتر حسب وجود فلتر فعال
            if (currentFilter !== 'all' || searchTerm || dateFromFilter || dateToFilter) {
                filterSummary.style.display = 'block';
            
        } else {
                filterSummary.style.display = 'none';
            
        }
        
        }
        
        // Actualizar el botón de filtro activo
        function updateActiveFilterButton(activeButton) {
            filterButtons.forEach(button => {
                button.classList.remove('active');
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
            
        });
            
            activeButton.classList.add('active');
            activeButton.classList.remove('btn-outline-primary');
            activeButton.classList.add('btn-primary');
        
        }

        // Mostrar detalles de un pedido
        function viewOrderDetails(orderId) {
            const order = allOrders.find(order => order.id === orderId);
            
            if (!order) {
                alert('لم يتم العثور على الطلب');
                return;
            
        }
            
            // Guardar los datos actuales del pedido para su posible edición
            currentOrderData = { ...order 
        };
            
            // Elementos del modal
            const orderIdElement = document.getElementById('orderDetailId');
            const orderDateElement = document.getElementById('orderDetailDate');
            const customerNameElement = document.getElementById('customerName');
            const customerPhoneElement = document.getElementById('customerPhone');
            const customerGovernorateElement = document.getElementById('customerGovernorate');
            const customerAddressElement = document.getElementById('customerAddress');
            const orderNotesElement = document.getElementById('orderNotes');
            const productsContainerElement = document.getElementById('productsContainer');
            const orderTotalElement = document.getElementById('orderTotal');
            const currentStatusElement = document.getElementById('currentStatus');
            
            // إنشاء رابط واتساب مع نص متهيئ
            const whatsappLink = createWhatsAppLink(order.customer_mobile, order.order_number);
            
            // Rellenar los datos del pedido
            orderIdElement.textContent = order.order_number;
            orderDateElement.textContent = formatDate(order.order_date);
            customerNameElement.textContent = order.customer_name;
            
            // جعل رقم الهاتف قابل للنقر
            customerPhoneElement.innerHTML = `
                <div class="d-flex align-items-center">
                    <a href="tel:${order.customer_mobile
        }" class="phone-link me-2">
                        ${order.customer_mobile
        }
                    </a>
                    <a href="${whatsappLink
        }" target="_blank" class="whatsapp-link" title="إرسال رسالة واتساب">
                        <i class="fab fa-whatsapp text-success"></i>
                    </a>
                </div>
                ${order.customer_alt_phone ? `
                <div class="mt-1 d-flex align-items-center text-muted">
                    <small>رقم بديل: </small>
                    <a href="tel:${order.customer_alt_phone
        }" class="phone-link me-2 ms-1 small">
                        ${order.customer_alt_phone
        }
                    </a>
                    <a href="${createWhatsAppLink(order.customer_alt_phone, order.order_number)
        }" target="_blank" class="whatsapp-link whatsapp-link-small" title="إرسال رسالة واتساب (رقم بديل)">
                        <i class="fab fa-whatsapp text-success"></i>
                    </a>
                </div>
                ` : ''
        }
            `;
            
            customerGovernorateElement.textContent = order.customer_governorate || 'لم يتم تحديد محافظة';
            customerAddressElement.textContent = order.customer_address || 'لم يتم تحديد عنوان';
            orderNotesElement.textContent = order.order_notes || 'لا توجد ملاحظات';
            orderTotalElement.textContent = order.total_price;
            
            // También rellenar los campos de edición
            document.getElementById('editCustomerName').value = order.customer_name;
            document.getElementById('editCustomerPhone').value = order.customer_mobile;
            document.getElementById('editCustomerAltPhone').value = order.customer_alt_phone || '';
            document.getElementById('editCustomerGovernorate').value = order.customer_governorate || '';
            document.getElementById('editCustomerAddress').value = order.customer_address || '';
            document.getElementById('editOrderNotes').value = order.order_notes || '';
            
            // Extraer precio numérico
            let numericPrice = order.total_price;
            if (typeof numericPrice === 'string') {
                numericPrice = numericPrice.replace(/[^\d]/g, '');
            
        }
            document.getElementById('editOrderTotal').value = numericPrice || '0';
            document.getElementById('editOrderDiscount').value = order.discount || '0';
            updateFinalPrice();
            
            // Establecer estado actual
            currentStatusElement.textContent = getStatusText(order.status || 'pending');
            currentStatusElement.className = `status-badge status-${order.status || 'pending'
        }`;
            
            // Seleccionar el estado actual en el dropdown
            statusUpdateSelect.value = order.status || 'pending';
            
            // Establecer el ID del pedido para la actualización
            updateStatusBtn.dataset.orderId = order.id;
            
            // Mostrar los productos
            productsContainerElement.innerHTML = '';
            
            try {
                let products = [];
                if (typeof order.product_details === 'string') {
                    products = JSON.parse(order.product_details);
                
        } else if (Array.isArray(order.product_details)) {
                    products = order.product_details;
                
        } else if (Array.isArray(order.products)) {
                    // Check for products field (which is used in script.js)
                    products = order.products;
                
        }
                
                if (products && products.length > 0) {
                    products.forEach((product, index) => {
                        const productElement = document.createElement('div');
                        productElement.className = 'product-item';
                        productElement.dataset.index = index;
                        
                        productElement.innerHTML = `
                            <div class="product-details">
                                <p><strong>اللون:</strong> ${getColorName(product.color)
        }</p>
                                <p><strong>المقاس:</strong> ${product.size
        }</p>
                                <p><strong>الكمية:</strong> ${product.quantity
        }</p>
                                
                                <div class="product-actions edit-mode" style="display: none;">
                                    <button class="btn btn-sm btn-outline-primary edit-product-btn">
                                        <i class="fas fa-edit"></i> تعديل
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger remove-product-btn">
                                        <i class="fas fa-trash"></i> حذف
                                    </button>
                                </div>
                                
                                <div class="product-edit-controls">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">اللون:</label>
                                            <select class="form-control edit-product-color">
                                                <option value="black" ${product.color === 'black' ? 'selected' : ''
        }>أسود</option>
                                                <option value="white" ${product.color === 'white' ? 'selected' : ''
        }>أبيض</option>
                                                <option value="silver" ${product.color === 'silver' ? 'selected' : ''
        }>فضي</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">المقاس:</label>
                                            <select class="form-control edit-product-size">
                                                <option value="S" ${product.size === 'S' ? 'selected' : ''
        }>S</option>
                                                <option value="M" ${product.size === 'M' ? 'selected' : ''
        }>M</option>
                                                <option value="L" ${product.size === 'L' ? 'selected' : ''
        }>L</option>
                                                <option value="XL" ${product.size === 'XL' ? 'selected' : ''
        }>XL</option>
                                                <option value="XXL" ${product.size === 'XXL' ? 'selected' : ''
        }>XXL</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">الكمية:</label>
                                            <input type="number" class="form-control edit-product-quantity" value="${product.quantity
        }" min="1" max="10">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-2">
                                        <button class="btn btn-sm btn-primary save-product-btn">حفظ</button>
                                        <button class="btn btn-sm btn-outline-secondary ms-2 cancel-product-edit-btn">إلغاء</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        productsContainerElement.appendChild(productElement);
                        
                        // Añadir event listeners
                        attachProductEventListeners(productElement);
                    
        });
                
        } else {
                    productsContainerElement.innerHTML = '<p class="text-muted">لا توجد تفاصيل للمنتجات</p>';
                
        }
            
        } catch (e) {
                console.error("Error parsing product details:", e);
                productsContainerElement.innerHTML = '<p class="text-danger">خطأ في عرض تفاصيل المنتجات</p>';
            
        }
            
            // Mostrar todos los detalles del pedido en una tabla
            const completeOrderDetailsElement = document.getElementById('completeOrderDetails');
            completeOrderDetailsElement.innerHTML = '';
            
            // Rellenar la tabla con los datos del pedido
            completeOrderDetailsElement.innerHTML = `
                <tr>
                    <th>رقم الطلب</th>
                    <td>${order.order_number
        }</td>
                </tr>
                <tr>
                    <th>تاريخ الطلب</th>
                    <td>${formatDate(order.order_date)
        }</td>
                </tr>
                <tr>
                    <th>اسم العميل</th>
                    <td>${order.customer_name
        }</td>
                </tr>
                <tr>
                    <th>رقم الهاتف</th>
                    <td>${order.customer_mobile
        }</td>
                </tr>
                <tr>
                    <th>رقم الهاتف البديل</th>
                    <td>${order.customer_alt_phone || '-'
        }</td>
                </tr>
                <tr>
                    <th>المحافظة</th>
                    <td>${order.customer_governorate || '-'
        }</td>
                </tr>
                <tr>
                    <th>عنوان العميل</th>
                    <td>${order.customer_address || '-'
        }</td>
                </tr>
                <tr>
                    <th>ملاحظات الطلب</th>
                    <td>${order.order_notes || '-'
        }</td>
                </tr>
                <tr>
                    <th>حالة الطلب</th>
                    <td>${getStatusText(order.status || 'pending')
        }</td>
                </tr>
                <tr>
                    <th>المبلغ الإجمالي</th>
                    <td>${order.total_price
        }</td>
                </tr>
                <tr>
                    <th>المنتجات</th>
                    <td class="product-details-cell">
                        ${renderProductDetails(order)
        }
                    </td>
                </tr>
            `;
            
            // Asegurarse de que el modo de edición está desactivado
            exitEditMode();
            
            // Mostrar el modal
            orderModalBackdrop.style.display = 'block';
            orderModal.style.display = 'block';
        
        }

        // Actualizar el estado de un pedido
        function updateOrderStatus() {
            const orderId = updateStatusBtn.dataset.orderId;
            const newStatus = statusUpdateSelect.value;
            
            if (!orderId) {
                alert('لم يتم تحديد طلب للتحديث');
                return;
            
        }
            
            updateStatusBtn.disabled = true;
            updateStatusBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحديث...';
            
            db.collection('orders').doc(orderId).update({
                status: newStatus
            
        })
            .then(() => {
                // Actualizar también en la colección diaria si existe
                const order = allOrders.find(o => o.id === orderId);
                if (order && order.order_date) {
                    const orderDate = new Date(order.order_date);
                    const dateString = orderDate.toISOString().split('T')[0];
                    
                    db.collection('orders_by_date').doc(dateString).collection('daily_orders').doc(orderId)
                        .update({ status: newStatus 
        })
                        .catch(error => console.error("Error updating daily order:", error));
                
        }
                
                // Actualizar UI
                updateOrderInLocalArray(orderId, newStatus);
                
                alert('تم تحديث حالة الطلب بنجاح');
                
                // Actualizar la vista
                viewOrderDetails(orderId);
                filterOrders(currentFilter);
                updateStatistics();
            
        })
            .catch(error => {
                console.error("Error updating order status:", error);
                alert('حدث خطأ أثناء تحديث حالة الطلب');
            
        })
            .finally(() => {
                updateStatusBtn.disabled = false;
                updateStatusBtn.innerHTML = 'تحديث الحالة';
            
        });
        
        }

        // Actualizar un pedido en el array local
        function updateOrderInLocalArray(orderId, newStatus) {
            const orderIndex = allOrders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                allOrders[orderIndex].status = newStatus;
            
        }
        
        }

        // Cerrar el modal de detalles del pedido
        function closeOrderModal() {
            orderModalBackdrop.style.display = 'none';
            orderModal.style.display = 'none';
        
        }

        // Mostrar estado vacío
        function showEmptyState() {
            emptyStateElement.style.display = 'block';
            document.getElementById('ordersTable').style.display = 'none';
        
        }

        // Ocultar estado vacío
        function hideEmptyState() {
            emptyStateElement.style.display = 'none';
            document.getElementById('ordersTable').style.display = 'table';
        
        }

        // Mostrar estado de error
        function showErrorState(message) {
            emptyStateElement.style.display = 'block';
            emptyStateElement.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <h5>خطأ</h5>
                <p>${message
        }</p>
            `;
            document.getElementById('ordersTable').style.display = 'none';
        
        }

        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            
            if (isNaN(date.getTime())) {
                return dateString;
            
        }
            
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            
        });
        
        }

        // Helper function to get Arabic color name
        function getColorName(color) {
            switch (color) {
                case 'black': return 'أسود';
                case 'beige': return 'بيج'; // Changed from white
                case 'silver': return 'فضي';
                default: return color; // Return code if name not found
            
        }
        
        }

        // Obtener texto de estado en áرabe
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'قيد الانتظار';
                case 'processing': return 'جاري التجهيز';
                case 'shipped': return 'تم الشحن';
                case 'delivered': return 'تم التوصيل';
                case 'cancelled': return 'ملغي';
                default: return 'قيد الانتظار';
            
        }
        
        }

        // Guardar los cambios realizados en el pedido
        function saveOrderChanges() {
            const orderId = updateStatusBtn.dataset.orderId;
            
            if (!orderId) {
                alert('حدث خطأ: لم يتم تحديد معرف الطلب');
                return;
            
        }
            
            // Mostrar indicador de guardado
            const saveBtn = document.getElementById('saveOrderChangesBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            
            // Recopilar los datos editados
            const editedOrder = {
                customer_name: document.getElementById('editCustomerName').value,
                customer_mobile: document.getElementById('editCustomerPhone').value,
                customer_alt_phone: document.getElementById('editCustomerAltPhone').value || '',
                customer_governorate: document.getElementById('editCustomerGovernorate').value || '',
                customer_address: document.getElementById('editCustomerAddress').value || '',
                order_notes: document.getElementById('editOrderNotes').value || ''
            
        };
            
            // Obtener descuento y precios
            const discount = document.getElementById('editOrderDiscount').value || '0';
            const originalPrice = document.getElementById('editOrderTotal').value || '0';
            const finalTotal = document.getElementById('editOrderFinalTotal').value || '0';
            
            editedOrder.discount = discount;
            editedOrder.original_price = originalPrice + ' ج.م';
            editedOrder.total_price = finalTotal;
            
            // Recopilar los productos actualizados
            const productItems = document.querySelectorAll('.product-item');
            const updatedProducts = [];
            
            productItems.forEach(item => {
                // Ignorar elementos que están siendo eliminados
                if (item.classList.contains('deleting')) {
                    return;
                
        }
                
                let color, size, quantity;
                
                // Si el producto está en modo edición, obtener de los controles de edición
                if (item.classList.contains('editing')) {
                    color = item.querySelector('.edit-product-color').value;
                    size = item.querySelector('.edit-product-size').value;
                    quantity = item.querySelector('.edit-product-quantity').value;
                
        } else {
                    // Obtener de los datos mostrados en las etiquetas p
                    const colorText = item.querySelector('p:nth-child(1)').textContent;
                    const sizeText = item.querySelector('p:nth-child(2)').textContent;
                    const quantityText = item.querySelector('p:nth-child(3)').textContent;
                    
                    color = getColorValue(colorText.replace('اللون:', '').trim());
                    size = sizeText.replace('المقاس:', '').trim();
                    quantity = parseInt(quantityText.replace('الكمية:', '').trim());
                
        }
                
                updatedProducts.push({
                    color: color,
                    size: size,
                    quantity: parseInt(quantity)
                
        });
            
        });
            
            // Actualizar datos del pedido
            editedOrder.product_details = JSON.stringify(updatedProducts);
            editedOrder.total_items = updatedProducts.length;
            
            // Fecha de actualización
            editedOrder.last_updated = new Date().toISOString();
            
            console.log("Guardando cambios en el pedido:", editedOrder);
            
            // Actualizar en Firebase
            db.collection('orders').doc(orderId).update(editedOrder)
                .then(() => {
                    // Actualizar el array local
                    const orderIndex = allOrders.findIndex(o => o.id === orderId);
                    if (orderIndex !== -1) {
                        allOrders[orderIndex] = { ...allOrders[orderIndex], ...editedOrder 
        };
                    
        }
                    
                    alert('تم حفظ التغييرات بنجاح');
                    
                    // Actualizar la vista
                    viewOrderDetails(orderId);
                    filterOrders(currentFilter);
                    updateStatistics();
                
        })
                .catch(error => {
                    console.error('Error al guardar cambios:', error);
                    alert('حدث خطأ أثناء حفظ التغييرات: ' + error.message);
                
        })
                .finally(() => {
                    // Restaurar botón de guardar
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات';
                    exitEditMode();
                
        });
        
        }
        
        // Añadir un nuevo producto al pedido
        function addNewProduct() {
            const productsContainer = document.getElementById('productsContainer');
            
            // Comprobar si ya existe un formulario de nuevo producto
            if (document.querySelector('.new-product-form')) {
                return; // Evitar agregar múltiples formularios
            
        }
            
            const newProductForm = document.createElement('div');
            newProductForm.className = 'new-product-form fade-in';
            
            newProductForm.innerHTML = `
                <h6>إضافة طقم جديد</h6>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">اللون:</label>
                        <select class="form-control new-product-color">
                            <option value="black">أسود</option>
                            <option value="white">أبيض</option>
                            <option value="silver">فضي</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">المقاس:</label>
                        <select class="form-control new-product-size">
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                            <option value="XXL">XXL</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">الكمية:</label>
                        <input type="number" class="form-control new-product-quantity" value="1" min="1" max="10">
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-2">
                    <button class="btn btn-sm btn-success confirm-new-product-btn">
                        <i class="fas fa-plus"></i> إضافة
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2 cancel-new-product-btn">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            `;
            
            productsContainer.prepend(newProductForm);
            
            // Añadir event listeners
            const confirmBtn = newProductForm.querySelector('.confirm-new-product-btn');
            const cancelBtn = newProductForm.querySelector('.cancel-new-product-btn');
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    const color = newProductForm.querySelector('.new-product-color').value;
                    const size = newProductForm.querySelector('.new-product-size').value;
                    const quantity = newProductForm.querySelector('.new-product-quantity').value;
                    
                    // Crear nuevo producto
                    const productElement = document.createElement('div');
                    productElement.className = 'product-item';
                    productElement.dataset.index = document.querySelectorAll('.product-item').length;
                    
                    productElement.innerHTML = `
                        <div class="product-details">
                            <p><strong>اللون:</strong> ${getColorName(color)
        }</p>
                            <p><strong>المقاس:</strong> ${size
        }</p>
                            <p><strong>الكمية:</strong> ${quantity
        }</p>
                            
                            <div class="product-actions edit-mode" style="display: none;">
                                <button class="btn btn-sm btn-outline-primary edit-product-btn">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="btn btn-sm btn-outline-danger remove-product-btn">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                            
                            <div class="product-edit-controls">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label">اللون:</label>
                                        <select class="form-control edit-product-color">
                                            <option value="black" ${color === 'black' ? 'selected' : ''
        }>أسود</option>
                                            <option value="white" ${color === 'white' ? 'selected' : ''
        }>أبيض</option>
                                            <option value="silver" ${color === 'silver' ? 'selected' : ''
        }>فضي</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label">المقاس:</label>
                                        <select class="form-control edit-product-size">
                                            <option value="S" ${size === 'S' ? 'selected' : ''
        }>S</option>
                                            <option value="M" ${size === 'M' ? 'selected' : ''
        }>M</option>
                                            <option value="L" ${size === 'L' ? 'selected' : ''
        }>L</option>
                                            <option value="XL" ${size === 'XL' ? 'selected' : ''
        }>XL</option>
                                            <option value="XXL" ${size === 'XXL' ? 'selected' : ''
        }>XXL</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label">الكمية:</label>
                                        <input type="number" class="form-control edit-product-quantity" value="${quantity
        }" min="1" max="10">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end mt-2">
                                    <button class="btn btn-sm btn-primary save-product-btn">حفظ</button>
                                    <button class="btn btn-sm btn-outline-secondary ms-2 cancel-product-edit-btn">إلغاء</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Eliminar formulario
                    newProductForm.remove();
                    
                    // Añadir nuevo producto
                    productsContainer.prepend(productElement);
                    
                    // Actualizar precio
                    updateTotalPrice();
                    
                    // Añadir event listeners
                    attachProductEventListeners(productElement);
                
        });
            
        }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    newProductForm.remove();
                
        });
            
        }
        
        }
        
        // Actualizar precio total basado en productos
        function updateTotalPrice() {
            // Precio base por producto
            const basePrice = 249;
            
            // Contar productos
            const productItems = document.querySelectorAll('.product-item:not(.deleting)');
            const productCount = productItems.length;
            
            // Calcular precio total
            let totalPrice = 0;
            productItems.forEach(item => {
                let quantity = 1;
                const quantityText = item.querySelector('p:nth-child(3)').textContent;
                quantity = parseInt(quantityText.replace('الكمية:', '').trim()) || 1;
                
                totalPrice += basePrice * quantity;
            
        });
            
            // Aplicar descuento por cantidad
            let discount = 0;
            if (productCount >= 3) discount = 10;
            else if (productCount >= 2) discount = 5;
            
            // Actualizar campos
            document.getElementById('editOrderTotal').value = totalPrice;
            document.getElementById('editOrderDiscount').value = discount;
            
            // Actualizar precio final
            updateFinalPrice();
        
        }
        
        // Añadir event listeners a un producto
        function attachProductEventListeners(productElement) {
            const editProductBtn = productElement.querySelector('.edit-product-btn');
            const removeProductBtn = productElement.querySelector('.remove-product-btn');
            const saveProductBtn = productElement.querySelector('.save-product-btn');
            const cancelEditBtn = productElement.querySelector('.cancel-product-edit-btn');
            
            if (editProductBtn) {
                editProductBtn.addEventListener('click', function() {
                    productElement.classList.add('editing');
                
        });
            
        }
            
            if (removeProductBtn) {
                removeProductBtn.addEventListener('click', function() {
                    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                        productElement.classList.add('deleting');
                        productElement.style.display = 'none';
                        // Actualizar precio total
                        updateTotalPrice();
                    
        }
                
        });
            
        }
            
            if (saveProductBtn) {
                saveProductBtn.addEventListener('click', function() {
                    // Obtener valores editados
                    const color = productElement.querySelector('.edit-product-color').value;
                    const size = productElement.querySelector('.edit-product-size').value;
                    const quantity = productElement.querySelector('.edit-product-quantity').value;
                    
                    // Actualizar texto mostrado
                    const colorP = productElement.querySelector('p:nth-child(1)');
                    const sizeP = productElement.querySelector('p:nth-child(2)');
                    const quantityP = productElement.querySelector('p:nth-child(3)');
                    
                    colorP.innerHTML = `<strong>اللون:</strong> ${getColorName(color)
        }`;
                    sizeP.innerHTML = `<strong>المقاس:</strong> ${size
        }`;
                    quantityP.innerHTML = `<strong>الكمية:</strong> ${quantity
        }`;
                    
                    // Salir del modo edición
                    productElement.classList.remove('editing');
                    
                    // Actualizar precio total
                    updateTotalPrice();
                
        });
            
        }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    productElement.classList.remove('editing');
                
        });
            
        }
        
        }

        // Actualizar el precio final después de aplicar descuento
        function updateFinalPrice() {
            const totalInput = document.getElementById('editOrderTotal');
            const discountInput = document.getElementById('editOrderDiscount');
            const finalTotalInput = document.getElementById('editOrderFinalTotal');
            
            if (totalInput && discountInput && finalTotalInput) {
                const total = parseFloat(totalInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                
                const discountAmount = total * (discount / 100);
                const finalTotal = total - discountAmount;
                
                // Formatear con moneda egipcia
                finalTotalInput.value = finalTotal.toFixed(0) + ' ج.م';
                
                console.log(`Precio original: ${total
        }, Descuento: ${discount}%, Final: ${finalTotal}`);
            
        }
        
        }

        // Entrar en modo de edición
        function enterEditMode() {
            console.log("Entrando en modo de edición");
            editMode = true;
            
            // Mostrar controles de edición
            document.querySelectorAll('.view-mode').forEach(element => {
                element.style.display = 'none';
            
        });
            
            document.querySelectorAll('.edit-mode').forEach(element => {
                element.style.display = 'block';
            
        });
            
            // Añadir clase a las secciones editables
            document.querySelectorAll('.product-item').forEach(element => {
                element.classList.add('editable');
            
        });
            
            // Hacer scroll suave al comienzo del modal para mayor comodidad
            const modalBody = document.querySelector('.order-modal-body');
            if (modalBody) {
                modalBody.scrollTop = 0;
            
        }
            
            // Actualizar cálculo de precio total basado en productos actuales
            updateTotalPrice();
            
            // Configurar eventos para guardar automáticamente
            setupAutoSaveEvents();
        
        }

        // Configurar eventos para guardar automáticamente
        function setupAutoSaveEvents() {
            // Para campos de texto y áreas de texto
            const textInputs = document.querySelectorAll('.edit-mode input[type="text"], .edit-mode textarea');
            textInputs.forEach(input => {
                input.addEventListener('blur', autoSaveOrderChanges);
                input.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                        autoSaveOrderChanges();
                    
        }
                
        });
            
        });
            
            // Para campos numéricos
            const numberInputs = document.querySelectorAll('.edit-mode input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('blur', autoSaveOrderChanges);
                input.addEventListener('change', autoSaveOrderChanges);
            
        });
            
            // Para selectores dropdown
            const selectInputs = document.querySelectorAll('.edit-mode select');
            selectInputs.forEach(select => {
                select.addEventListener('change', autoSaveOrderChanges);
            
        });
        
        }

        // Guardar cambios automáticamente
        function autoSaveOrderChanges() {
            const orderId = updateStatusBtn.dataset.orderId;
            if (!orderId) {
                console.error('No se ha definido un ID de pedido para guardar');
                return;
            
        }
            
            // Mostrar indicador de guardado
            const saveBtn = document.getElementById('saveOrderChangesBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            
            // Recopilar los datos editados
            const updatedOrderData = {
                customer_name: document.getElementById('editCustomerName').value,
                customer_mobile: document.getElementById('editCustomerPhone').value,
                customer_alt_phone: document.getElementById('editCustomerAltPhone').value,
                customer_governorate: document.getElementById('editCustomerGovernorate').value,
                customer_address: document.getElementById('editCustomerAddress').value,
                order_notes: document.getElementById('editOrderNotes').value
            
        };
            
            // Actualizar productos del pedido
            const productsContainer = document.getElementById('productsContainer');
            const productItems = productsContainer.querySelectorAll('.product-item');
            
            let products = [];
            productItems.forEach((item, index) => {
                const productData = {
                    id: index + 1,
                    color: 'black',
                    size: 'L',
                    quantity: 1
                
        };
                
                const colorSelect = item.querySelector('.edit-product-color');
                const sizeSelect = item.querySelector('.edit-product-size');
                const quantityInput = item.querySelector('.edit-product-quantity');
                
                if (colorSelect) {
                    productData.color = colorSelect.value;
                
        }
                
                if (sizeSelect) {
                    productData.size = sizeSelect.value;
                
        }
                
                if (quantityInput) {
                    productData.quantity = parseInt(quantityInput.value) || 1;
                
        }
                
                products.push(productData);
            
        });
            
            // Si hay productos, actualizarlos en los datos
            if (products.length > 0) {
                updatedOrderData.products = products;
                updatedOrderData.product_details = JSON.stringify(products);
                updatedOrderData.total_items = products.length;
            
        }
            
            // Mostrar indicador de guardado
            const saveIndicator = document.createElement('div');
            saveIndicator.className = 'auto-save-indicator';
            saveIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            saveIndicator.style.position = 'fixed';
            saveIndicator.style.top = '20px';
            saveIndicator.style.right = '20px';
            saveIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
            saveIndicator.style.color = 'white';
            saveIndicator.style.padding = '10px 15px';
            saveIndicator.style.borderRadius = '5px';
            saveIndicator.style.zIndex = '9999';
            document.body.appendChild(saveIndicator);
            
            // Guardar en Firestore
            db.collection('orders').doc(orderId).update(updatedOrderData)
                .then(() => {
                    // Actualizar array local
                    updateLocalOrderData(orderId, updatedOrderData);
                    
                    // Actualizar también en órdenes diarias si existe
                    const order = allOrders.find(o => o.id === orderId);
                    if (order && order.order_date) {
                        const orderDate = new Date(order.order_date);
                        const dateString = orderDate.toISOString().split('T')[0];
                        
                        db.collection('orders_by_date').doc(dateString).collection('daily_orders').doc(orderId)
                            .update(updatedOrderData)
                            .catch(error => console.error("Error al actualizar pedido diario:", error));
                    
        }
                    
                    // Cambiar indicador a guardado exitoso
                    saveIndicator.innerHTML = '<i class="fas fa-check"></i> تم الحفظ';
                    saveIndicator.style.background = 'rgba(76, 175, 80, 0.8)';
                    
                    // Eliminar indicador después de 3 segundos
                    setTimeout(() => {
                        if (saveIndicator.parentNode) {
                            saveIndicator.parentNode.removeChild(saveIndicator);
                        
        }
                    
        }, 3000);
                
        })
                .catch(error => {
                    console.error('Error al guardar cambios:', error);
                    
                    // Mostrar indicador de error
                    saveIndicator.innerHTML = '<i class="fas fa-times"></i> فشل الحفظ';
                    saveIndicator.style.background = 'rgba(244, 67, 54, 0.8)';
                    
                    // Eliminar indicador después de 3 segundos
                    setTimeout(() => {
                        if (saveIndicator.parentNode) {
                            saveIndicator.parentNode.removeChild(saveIndicator);
                        
        }
                    
        }, 3000);
                
        });
        
        }
        
        // Actualizar datos del pedido en el array local
        function updateLocalOrderData(orderId, updatedData) {
            const orderIndex = allOrders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                // Actualizar solo las propiedades que se han cambiado
                allOrders[orderIndex] = {
                    ...allOrders[orderIndex],
                    ...updatedData
                
        };
            
        }
        
        }

        // Salir del modo de edición
        function exitEditMode() {
            console.log("Saliendo del modo de edición");
            editMode = false;
            
            // Ocultar controles de edición
            document.querySelectorAll('.view-mode').forEach(element => {
                element.style.display = 'block';
            
        });
            
            document.querySelectorAll('.edit-mode').forEach(element => {
                element.style.display = 'none';
            
        });
            
            // Quitar clase editable de los productos
            document.querySelectorAll('.product-item').forEach(item => {
                item.classList.remove('editable');
                item.classList.remove('editing');
            
        });
            
            // Eliminar formulario de nuevo producto si existe
            const newProductForm = document.querySelector('.new-product-form');
            if (newProductForm) {
                newProductForm.remove();
            
        }
            
            // Restaurar productos eliminados
            document.querySelectorAll('.product-item.deleting').forEach(item => {
                item.classList.remove('deleting');
                item.style.display = 'block';
            
        });
        
        }

        // Obtener el valor del color basado en el nombre en áرabe
        function getColorValue(arabicName) {
            const colorMap = {
                'أسود': 'black',
                'أبيض': 'white',
                'فضي': 'silver'
            
        };
            
            return colorMap[arabicName.trim()] || 'black';
        
        }

        // Detectar cambios en las celdas de precios
        document.querySelectorAll('#editOrderTotal, #editOrderDiscount').forEach(input => {
            input.addEventListener('input', updateFinalPrice);
        
        });
        
        // Función para exportar pedidos a Excel
        function exportOrdersToExcel() {
            // تحديد الطلبات المفلترة حالياً بناءً على الفلتر النشط والبحث
            let filteredOrders = allOrders;
            
            // تطبيق فلتر الحالة (إذا كان مختلفاً عن "الكل")
            if (currentFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === currentFilter);
            
        }
            
            // تطبيق فلتر التاريخ
            if (dateFromFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    let orderDate;
                    try {
                        orderDate = new Date(order.order_date);
                    
        } catch (e) {
                        return false;
                    
        }
                    return orderDate >= dateFromFilter;
                
        });
            
        }
            
            if (dateToFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    let orderDate;
                    try {
                        orderDate = new Date(order.order_date);
                    
        } catch (e) {
                        return false;
                    
        }
                    return orderDate <= dateToFilter;
                
        });
            
        }
            
            // تطبيق فلتر البحث (إذا كان موجوداً)
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm !== '') {
                filteredOrders = filteredOrders.filter(order => {
                    return (
                        order.order_number.toLowerCase().includes(searchTerm) ||
                        order.customer_name.toLowerCase().includes(searchTerm) ||
                        order.customer_mobile.includes(searchTerm)
                    );
                
        });
            
        }
            
            if (filteredOrders.length === 0) {
                alert('لا توجد بيانات للتصدير بناءً على الفلاتر الحالية');
                return;
            
        }
            
            // إنشاء مصفوفة البيانات للتصدير
            const exportData = [];
            // إضافة رأس الجدول
            exportData.push([
                'رقم الطلب',
                'اسم العميل',
                'رقم الهاتف',
                'المحافظة',
                'تاريخ الطلب',
                'عدد المنتجات',
                'السعر الإجمالي',
                'ملاحظات',
                'حالة الطلب'
            ]);
            
            // إضافة بيانات الطلبات المفلترة
            filteredOrders.forEach((order) => {
                // تنسيق تفاصيل المنتجات كنص
                let productsText = '';
                try {
                    let products = [];
                    if (typeof order.product_details === 'string') {
                        products = JSON.parse(order.product_details);
                    
        } else if (Array.isArray(order.product_details)) {
                        products = order.product_details;
                    
        } else if (Array.isArray(order.products)) {
                        // Also check for products field (used in script.js)
                        products = order.products;
                    
        }
                    
                    productsText = products.map(p => 
                        `اللون: ${getColorName(p.color)
        }, المقاس: ${p.size}, الكمية: ${p.quantity}`
                    ).join(' | ');
                
        } catch (e) {
                    productsText = order.product_details || order.products || 'غير متوفر';
                
        }
                
                // تنسيق التاريخ
                let formattedDate = '';
                try {
                    const date = new Date(order.order_date);
                    formattedDate = `${date.getDate()
        }/${date.getMonth() + 1}/${date.getFullYear()} - ${date.getHours()}:${date.getMinutes()}`;
                
        } catch (e) {
                    formattedDate = order.order_date || '';
                
        }
                
                // إضافة صف البيانات
                exportData.push([
                    order.order_number || '',
                    order.customer_name || '',
                    order.customer_mobile || '',
                    order.customer_governorate || '',
                    formattedDate,
                    order.total_items || '',
                    order.total_price || '',
                    order.order_notes || '',
                    getStatusText(order.status) || 'قيد الانتظار'
                ]);
            
        });
            
            // إنشاء ملف اكسل
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            
            // إضافة ورقة للملف
            XLSX.utils.book_append_sheet(wb, ws, 'طلبات HELDEN');
            
            // الحصول على تاريخ اليوم
            const today = new Date();
            const dateString = `${today.getFullYear()
        }-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            
            // تنزيل الملف
            XLSX.writeFile(wb, `طلبات_HELDEN_${dateString
        }.xlsx`);
            
            // إظهار رسالة نجاح مع عدد الطلبات المصدرة
            alert(`تم تصدير ${filteredOrders.length
        } طلب بنجاح!`);
        
        }
        
        // ربط زر التصدير بوظيفة التصدير
        document.getElementById('exportBtn').addEventListener('click', exportOrdersToExcel);

        // تصدير طلب واحد إلى ملف Excel
        function exportSingleOrder(orderId) {
            const order = allOrders.find(order => order.id === orderId);
            
            if (!order) {
                alert('لم يتم العثور على الطلب');
                return;
            
        }
            
            // إنشاء مصفوفة البيانات للتصدير
            const exportData = [];
            // إضافة رأس الجدول
            exportData.push([
                'رقم الطلب',
                'اسم العميل',
                'رقم الهاتف',
                'المحافظة',
                'تاريخ الطلب',
                'عدد المنتجات',
                'السعر الإجمالي',
                'ملاحظات',
                'حالة الطلب'
            ]);
            
            // تنسيق تفاصيل المنتجات كنص
            let productsText = '';
            try {
                let products = [];
                if (typeof order.product_details === 'string') {
                    products = JSON.parse(order.product_details);
                
        } else if (Array.isArray(order.product_details)) {
                    products = order.product_details;
                
        } else if (Array.isArray(order.products)) {
                    // Also check for products field (used in script.js)
                    products = order.products;
                
        }
                
                productsText = products.map(p => 
                    `اللون: ${getColorName(p.color)
        }, المقاس: ${p.size}, الكمية: ${p.quantity}`
                ).join(' | ');
            
        } catch (e) {
                productsText = order.product_details || order.products || 'غير متوفر';
            
        }
            
            // تنسيق التاريخ
            let formattedDate = '';
            try {
                const date = new Date(order.order_date);
                formattedDate = `${date.getDate()
        }/${date.getMonth() + 1}/${date.getFullYear()} - ${date.getHours()}:${date.getMinutes()}`;
            
        } catch (e) {
                formattedDate = order.order_date || '';
            
        }
            
            // إضافة صف البيانات
            exportData.push([
                order.order_number || '',
                order.customer_name || '',
                order.customer_mobile || '',
                order.customer_governorate || '',
                formattedDate,
                order.total_items || '',
                order.total_price || '',
                order.order_notes || '',
                getStatusText(order.status) || 'قيد الانتظار'
            ]);
            
            // إنشاء ملف اكسل
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            
            // إضافة ورقة للملف
            XLSX.utils.book_append_sheet(wb, ws, `طلب - ${order.order_number
        }`);
            
            // الحصول على تاريخ اليوم
            const today = new Date();
            const dateString = `${today.getFullYear()
        }-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            
            // تنزيل الملف
            XLSX.writeFile(wb, `طلب_${order.order_number
        }_${dateString}.xlsx`);
            
            // إظهار رسالة نجاح مع عدد الطلبات المصدرة
            alert(`تم تصدير ${1
        } طلب بنجاح!`);
        
        }

        // تنسيق رقم الهاتف للواتساب (إزالة + أو بدء بـ 00 وإزالة المسافات)
        function formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            
            // إزالة المسافات والرموز الخاصة
            let formatted = phone.replace(/\s+/g, '');
            
            // إذا كان يبدأ بـ +
            if (formatted.startsWith('+')) {
                formatted = formatted.substring(1);
            
        }
            
            // إذا لم يبدأ بـ 00 أو 2 (مصر) نضيف 2 (كود مصر)
            if (!formatted.startsWith('00') && !formatted.startsWith('2')) {
                formatted = '2' + formatted;
            
        }
            
            // إذا بدأ بـ 00 نستبدله بـ ""
            if (formatted.startsWith('00')) {
                formatted = formatted.substring(2);
            
        }
            
            return formatted;
        
        }
        
        // إنشاء رابط واتساب مع نص متهيئ
        function createWhatsAppLink(phone, orderNumber) {
            const formattedPhone = formatPhoneForWhatsApp(phone);
            if (!formattedPhone) return '#';
            
            const whatsappText = encodeURIComponent(`مرحبًا! أنا من فريق HELDEN. نود تأكيد طلبك رقم #${orderNumber
        }. هل يمكنك تأكيد تفاصيل الطلب والعنوان؟`);
            
            return `https://wa.me/${formattedPhone
        }?text=${whatsappText}`;
        
        }
        
        // Render product details in a formatted string
        function renderProductDetails(order) {
            try {
                let products = [];
                if (typeof order.product_details === 'string') {
                    products = JSON.parse(order.product_details);
                
        } else if (Array.isArray(order.product_details)) {
                    products = order.product_details;
                
        } else if (Array.isArray(order.products)) {
                    // Also check for products field (used in script.js)
                    products = order.products;
                
        }
                
                if (products && products.length > 0) {
                    return products.map(p => 
                        `اللون: ${getColorName(p.color)
        }, المقاس: ${p.size}, الكمية: ${p.quantity}`
                    ).join(' | ');
                
        } else {
                    return 'لا توجد تفاصيل للمنتجات';
                
        }
            
        } catch (e) {
                console.error("Error parsing product details:", e);
                return 'خطأ في عرض تفاصيل المنتجات';
            
        }
        
        }
    </script>
</body>
</html>
